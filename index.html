<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Твоята Хранителна Подкрепа</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* === Психологически съобразена цветова палитра === */
        :root {
            --color-bg: #FDFCF9; /* Много меко, топло бяло */
            --color-card-bg: #FFFFFF;
            --color-text-primary: #3D4A5C; /* Тъмно, но меко сиво-синьо */
            --color-text-secondary: #7A8AA0;
            --color-primary-action: #2E8B57; /* Морско зелено - цвят на растеж и спокойствие */
            --color-primary-action-hover: #38a86a;
            --color-shadow: rgba(61, 74, 92, 0.08);

            /* Цветове за групите - пастелни и природни */
            --color-group1: #4CAF50; /* Поддръжка - Зелено (Растеж) */
            --color-group2: #2196F3; /* Имунитет - Синьо (Чистота) */
            --color-group3: #9C27B0; /* Регулация - Лилаво (Баланс) */
            --color-group4: #FFC107; /* Мозък - Жълто (Яснота) */
            --color-group5: #FF9800; /* Движение - Оранжево (Енергия) */
            --color-group6: #B0BEC5; /* Резерви - Неутрално сиво */
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html { font-size: 16px; }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-primary);
            padding: 1.5rem 1rem;
            -webkit-tap-highlight-color: transparent; /* Премахва синия фон при докосване на мобилни */
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        header { text-align: center; margin-bottom: 2rem; }
        header h1 { font-size: 1.75rem; margin-bottom: 0.5rem; }
        header p { font-size: 1rem; color: var(--color-text-secondary); }

        /* === Секция за въвеждане === */
        .input-section {
            background-color: var(--color-card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 8px 24px var(--color-shadow);
            margin-bottom: 2rem;
        }

        #food-input {
            width: 100%;
            min-height: 100px;
            padding: 1rem;
            border: 1px solid #E0E7F1;
            border-radius: 12px;
            resize: vertical;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            background-color: var(--color-bg);
        }
        #food-input:focus { outline: 2px solid var(--color-primary-action); }

        .ai-selector {
            display: flex;
            border: 1px solid #E0E7F1;
            border-radius: 10px;
            margin: 1rem 0;
            overflow: hidden;
        }
        .ai-btn {
            flex: 1;
            padding: 0.75rem;
            background-color: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            transition: all 0.2s ease-in-out;
        }
        .ai-btn.active {
            background-color: var(--color-primary-action);
            color: white;
            box-shadow: 0 2px 8px rgba(46, 139, 87, 0.3);
        }

        #analyze-btn {
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
            background-color: var(--color-primary-action);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #analyze-btn:hover { background-color: var(--color-primary-action-hover); }
        #analyze-btn:disabled { background-color: #a6d3b8; cursor: not-allowed; }

        /* === Индикатори за състояние (зареждане, грешка) === */
        .status-indicator { display: none; margin-top: 1rem; text-align: center; }
        .loader {
            width: 24px; height: 24px;
            border: 3px solid rgba(46, 139, 87, 0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .error-message {
            background-color: #ffdde0; color: #b71c1c;
            padding: 0.75rem; border-radius: 8px; font-size: 0.9rem;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* === Дневен списък === */
        .log-section { margin-bottom: 2rem; display: none; }
        .log-section h2 { font-size: 1.2rem; margin-bottom: 0.75rem; }
        #food-log-list {
            list-style: none;
            padding: 0;
            background: var(--color-card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 16px var(--color-shadow);
        }
        .log-item {
            padding: 0.8rem 1rem;
            border-bottom: 1px solid #f0f3f7;
            color: var(--color-text-primary);
            font-size: 0.95rem;
        }
        .log-item:last-child { border-bottom: none; }

        /* === Резултати === */
        #results-container {
            display: grid;
            gap: 1.25rem;
            grid-template-columns: 1fr; /* Една колона за мобилни */
        }
        .card {
            background-color: var(--color-card-bg);
            border-radius: 16px;
            padding: 1.25rem;
            box-shadow: 0 8px 24px var(--color-shadow);
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; }
        .card-header h3 { font-size: 1rem; font-weight: 600; }
        .info-btn { background-color: #f0f3f7; border: none; border-radius: 50%; width: 24px; height: 24px; font-weight: bold; cursor: pointer; color: var(--color-text-secondary); font-style: italic; }
        .card-visual { display: flex; justify-content: center; align-items: center; margin-bottom: 1rem; position: relative; }
        .progress-circle { width: 100px; height: 100px; border-radius: 50%; display: grid; place-items: center; background: conic-gradient(var(--color) calc(var(--value) * 1%), #f0f3f7 0); transition: background 1s ease-out; }
        .progress-circle::before { content: ""; position: absolute; width: 80px; height: 80px; background: var(--color-card-bg); border-radius: 50%; }
        .progress-value { position: relative; font-size: 1.5rem; font-weight: 600; color: var(--color-text-primary); }
        .card-special-text { font-size: 0.9rem; color: var(--color-text-secondary); min-height: 100px; display: flex; align-items: center; justify-content: center; text-align: center; padding: 1rem; background-color: #f8f9fa; border-radius: 8px; }
        .card-details { display: none; margin-top: 1rem; font-size: 0.85rem; color: #495057; background-color: #f8f9fa; padding: 1rem; border-radius: 8px; }
        .card-details.visible { display: block; }
        
        /* === Бутон за ресет === */
        .reset-container { text-align: center; margin-top: 2.5rem; }
        #reset-btn {
            background: none; border: 1px solid #d1d9e4;
            color: var(--color-text-secondary);
            padding: 0.6rem 1.2rem; border-radius: 8px;
            cursor: pointer; font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        #reset-btn:hover { background-color: #f0f3f7; border-color: #c1ccd9; }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Как подкрепи тялото си днес?</h1>
            <p>Въведи какво си хапнал(а) и виж какви ресурси осигуряваш за своите функции.</p>
        </header>

        <main>
            <section class="input-section">
                <textarea id="food-input" placeholder="Например: овесени ядки с банан и няколко ореха..."></textarea>
                
                <div class="ai-selector">
                    <button class="ai-btn" data-model="gpt">GPT-3.5</button>
                    <button class="ai-btn active" data-model="gemini">Gemini</button>
                </div>

                <button id="analyze-btn">
                    <span id="btn-text">Добави грижа</span>
                    <div id="loader" class="loader status-indicator"></div>
                </button>
                <div id="error-container" class="status-indicator"></div>
            </section>

            <section class="log-section" id="log-section">
                <h2>Ти добави:</h2>
                <ul id="food-log-list"></ul>
            </section>

            <section id="results-container">
                <!-- Картите се генерират от JavaScript при зареждане -->
            </section>

            <div class="reset-container">
                <button id="reset-btn">Започни нов ден</button>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Елементи ---
        const foodInput = document.getElementById('food-input');
        const analyzeBtn = document.getElementById('analyze-btn');
        const btnText = document.getElementById('btn-text');
        const loader = document.getElementById('loader');
        const errorContainer = document.getElementById('error-container');
        const resultsContainer = document.getElementById('results-container');
        const aiSelector = document.querySelector('.ai-selector');
        const logSection = document.getElementById('log-section');
        const foodLogList = document.getElementById('food-log-list');
        const resetBtn = document.getElementById('reset-btn');

        // --- API Endpoint ---
        const API_URL = 'https://macros.radilov-k.workers.dev/';

        // --- Състояние на приложението ---
        let currentProgress = {};
        let foodLog = [];
        let selectedModel = 'gemini'; // Default model

        // --- Константи ---
        const cardData = [
            { id: 1, title: 'Поддръжка и Възстановяване', color: 'var(--color-group1)' },
            { id: 2, title: 'Имунитет и Пречистване', color: 'var(--color-group2)' },
            { id: 3, title: 'Хормони и Регулация', color: 'var(--color-group3)' },
            { id: 4, title: 'Мозъчна Дейност', color: 'var(--color-group4)' },
            { id: 5, title: 'Двигателни Процеси', color: 'var(--color-group5)' },
            { id: 6, title: 'Запасяване и Резерви', color: 'var(--color-group6)', isSpecial: true }
        ];
        
        // --- Инициализация ---
        function init() {
            renderCards();
            loadStateFromStorage();
            updateUI();
            setupEventListeners();
        }

        function renderCards() {
            resultsContainer.innerHTML = '';
            cardData.forEach(data => {
                const cardHTML = `
                    <div class="card" id="card-${data.id}">
                        <div class="card-header">
                            <h3>${data.id}. ${data.title}</h3>
                        </div>
                        <div class="card-visual">
                            ${data.isSpecial ? 
                                `<div class="card-special-text">Всички ресурси се използват за текущите нужди на тялото.</div>` :
                                `<div class="progress-circle" style="--color: ${data.color}; --value: 0;">
                                    <span class="progress-value">0%</span>
                                </div>`
                            }
                        </div>
                    </div>
                `;
                resultsContainer.innerHTML += cardHTML;
            });
        }

        // --- Управление на състоянието ---
        function loadStateFromStorage() {
            const savedProgress = localStorage.getItem('dailyProgress');
            const savedLog = localStorage.getItem('dailyFoodLog');
            const savedDate = localStorage.getItem('savedDate');
            const today = new Date().toLocaleDateString();

            if (savedDate === today) {
                currentProgress = savedProgress ? JSON.parse(savedProgress) : {};
                foodLog = savedLog ? JSON.parse(savedLog) : [];
            } else {
                // It's a new day, clear old data
                resetState(false); // false means don't show confirmation
            }
        }

        function saveStateToStorage() {
            localStorage.setItem('dailyProgress', JSON.stringify(currentProgress));
            localStorage.setItem('dailyFoodLog', JSON.stringify(foodLog));
            localStorage.setItem('savedDate', new Date().toLocaleDateString());
        }
        
        function resetState(confirmUser = true) {
            if (confirmUser && !confirm("Сигурни ли сте, че искате да изтриете целия дневен напредък?")) {
                return;
            }
            currentProgress = {};
            foodLog = [];
            saveStateToStorage();
            updateUI();
        }

        // --- UI Функции ---
        function updateUI() {
            // Update progress cards
            for (let i = 1; i <= 6; i++) {
                const card = document.getElementById(`card-${i}`);
                if (!card) continue;
                
                const percentage = currentProgress[`group${i}_percentage`] || 0;

                if (i < 6) {
                    const circle = card.querySelector('.progress-circle');
                    const valueSpan = card.querySelector('.progress-value');
                    circle.style.setProperty('--value', percentage);
                    valueSpan.textContent = `${percentage}%`;
                } else {
                    const specialText = card.querySelector('.card-special-text');
                    specialText.textContent = percentage > 0 
                        ? `Малка част от ресурсите се насочва към резерви.`
                        : "Всички ресурси се използват за текущите нужди на тялото.";
                }
            }
            // Update food log
            if (foodLog.length > 0) {
                logSection.style.display = 'block';
                foodLogList.innerHTML = foodLog.map(item => `<li class="log-item">${item}</li>`).join('');
            } else {
                logSection.style.display = 'none';
            }
        }

        function showLoading(isLoading) {
            if (isLoading) {
                btnText.style.display = 'none';
                loader.style.display = 'block';
                analyzeBtn.disabled = true;
                errorContainer.style.display = 'none';
            } else {
                btnText.style.display = 'block';
                loader.style.display = 'none';
                analyzeBtn.disabled = false;
            }
        }

        function showError(message) {
            errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
            errorContainer.style.display = 'block';
        }

        // --- Основна логика и Event Listeners ---
        async function handleAnalysis() {
            const text = foodInput.value.trim();
            if (text === '') return;

            showLoading(true);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, model: selectedModel })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Сървърът върна грешка.');
                }

                const data = await response.json();
                
                // Add new percentages to current progress
                Object.keys(data).forEach(key => {
                    const currentVal = currentProgress[key] || 0;
                    currentProgress[key] = Math.min(100, currentVal + data[key]);
                });
                
                // Update log
                foodLog.push(text);
                
                saveStateToStorage();
                updateUI();
                foodInput.value = '';

            } catch (error) {
                console.error("Analysis Error:", error);
                showError("Възникна трудност при анализа. Моля, опитайте с по-ясно описание на храната.");
            } finally {
                showLoading(false);
            }
        }

        function setupEventListeners() {
            analyzeBtn.addEventListener('click', handleAnalysis);
            resetBtn.addEventListener('click', () => resetState(true));

            aiSelector.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    document.querySelectorAll('.ai-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    selectedModel = e.target.dataset.model;
                }
            });
        }
        
        // --- Старт на приложението ---
        init();
    });
    </script>
</body>
</html>
